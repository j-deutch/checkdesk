<?php

/**
 * Implementation of hook_menu().
 */
function checkdesk_sources_menu() {
  return array(
    'admin/config/services/checkdesk-sources' => array(
      'title' => 'Checkdesk Sources',
      'description' => 'Administer Checkdesk Sources configuration',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('_checkdesk_sources_admin_settings'),
      'access arguments' => array('administer site configuration'),
    ),
  );
}

function _checkdesk_sources_admin_settings() {
  $form['checkdesk_sources_pender_key'] = array(
    '#type' => 'textfield',
    '#title' => t('Pender API key'),
    '#description' => t('This key is shared with Pender service in order to communicate securely.'),
    '#default_value' => variable_get('checkdesk_sources_pender_key'),
  );
  $form['checkdesk_sources_pender_host'] = array(
    '#type' => 'textfield',
    '#title' => t('Pender host'),
    '#description' => t('Host where Pender is running.'),
    '#default_value' => variable_get('checkdesk_sources_pender_host'),
  );
  return system_settings_form($form);
}

/**
 * Implements hook_node_presave().
 */
function checkdesk_sources_node_presave($node) {
  if ($node->type === 'source' && $node->is_new) {
    $ch = curl_init('PENDER');
    curl_setopt($ch, CURLOPT_URL, variable_get('checkdesk_sources_pender_host') . '/api/medias?url=' . $node->source_url[LANGUAGE_NONE][0]['value']);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HEADER, 0);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array('X-Pender-Token: ' . variable_get('checkdesk_sources_pender_key')));
    $response = json_decode(curl_exec($ch));
    curl_close($ch);
    if ($response->type === 'media') {
      $i = 0;
      $node->source_data = array(LANGUAGE_NONE => array());
      foreach($response->data as $key => $value) {
        $node->source_data[LANGUAGE_NONE][$i] = array('first' => $key, 'second' => $value);
        $i++;
      }
    }
  }
}
