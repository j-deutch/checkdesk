<?php

/**
 * Modal function for `flag_confirm`.
 */
function _checkdesk_core_flags_confirm_modal($action, $flag, $nid, $js) {

    if (!$js) {
        return drupal_get_form('flag_confirm', $action, $flag, $nid);
    }

    module_load_include('inc', 'flag', 'includes/flag.pages');

    ctools_include('modal');
    ctools_include('ajax');
    $title_ac = '';
    if (isset($flag->action)) {
        $action_confirmation = $flag->action . '_confirmation';
        $title_ac = isset($flag->$action_confirmation) ? $flag->$action_confirmation: '';
    }

    // Pass to form generated by the Flag module
    $form_state = array(
        'title' => $title_ac,
        'ajax' => TRUE,
        'build_info' => array(
            'args' => array(
                0 => $action,
                1 => $flag,
                3 => $nid,
            ),
        ),
    );

    $commands = ctools_modal_form_wrapper('flag_confirm', $form_state);

    if (!empty($form_state['executed'])) {
        // Add the responder javascript, required by ctools
        ctools_add_js('ajax-responder');

        // Array with ajax response
        $commands = array();

        // Refresh messages
        $commands[] = ajax_command_html('#messages-container', theme('status_messages'));
        $new_link = trim(flag_create_link($flag->name, $nid));

        // Update link (we need to wrap the link in order to get the correct behavior)
        $commands[] = ajax_command_invoke('.node-' . $nid . ' .flag-' . $flag->name, 'replaceWith', array($new_link));
        $commands[] = checkdesk_core_ajax_command_attach_behaviors('.node-' . $nid . ' .flag-as');

        // Check if this report is flagged and highlight icon or not
        $flags = flag_get_flags('node');
        $class = 'unflagged';
        foreach ($flags as $flag) {
            if ($flag->is_flagged($nid)) {
                $class = 'flagged';
            }
        }
        $commands[] = ajax_command_invoke('.node-' . $nid . ' .flag-as > a', 'removeClass', array('flagged unflagged'));
        $commands[] = ajax_command_invoke('.node-' . $nid . ' .flag-as > a', 'addClass', array($class));

        // Dismiss modal
        $commands[] = ctools_modal_command_dismiss();
    }

    print ajax_render($commands);

    exit();
}
